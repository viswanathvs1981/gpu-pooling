{{- if .Values.dataopsAgents.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dataops-agents
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  replicas: {{ .Values.dataopsAgents.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: tensor-fusion
      app.kubernetes.io/component: dataops-agents
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tensor-fusion
        app.kubernetes.io/component: dataops-agents
    spec:
      serviceAccountName: {{ include "tensor-fusion.serviceAccountName" . }}
      containers:
      - name: dataops-agents
        image: "{{ .Values.dataopsAgents.image.repository }}:{{ .Values.dataopsAgents.image.tag }}"
        imagePullPolicy: {{ .Values.dataopsAgents.image.pullPolicy }}
        ports:
        - name: pipeline
          containerPort: 8081
        - name: feature
          containerPort: 8082
        - name: drift
          containerPort: 8083
        - name: lineage
          containerPort: 8084
        - name: experiment
          containerPort: 8085
        env:
        - name: AGENT_TYPE
          value: "all"
        resources:
          {{- toYaml .Values.dataopsAgents.resources | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /health
            port: pipeline
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /health
            port: pipeline
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: dataops-pipeline
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  type: ClusterIP
  ports:
  - port: 8081
    targetPort: pipeline
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
---
apiVersion: v1
kind: Service
metadata:
  name: dataops-feature
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  type: ClusterIP
  ports:
  - port: 8082
    targetPort: feature
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
---
apiVersion: v1
kind: Service
metadata:
  name: dataops-drift
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  type: ClusterIP
  ports:
  - port: 8083
    targetPort: drift
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
---
apiVersion: v1
kind: Service
metadata:
  name: dataops-lineage
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  type: ClusterIP
  ports:
  - port: 8084
    targetPort: lineage
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
---
apiVersion: v1
kind: Service
metadata:
  name: dataops-experiment
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
spec:
  type: ClusterIP
  ports:
  - port: 8085
    targetPort: experiment
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: tensor-fusion
    app.kubernetes.io/component: dataops-agents
{{- end }}

